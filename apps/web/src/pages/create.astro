---
export const prerender = false;
import Base from '../layouts/Base.astro';
import citiesData from '../../../worker/data/cities.json';

const url = new URL(Astro.request.url);
const key = url.searchParams.get('key') ?? '';
const token: string = Astro.locals.runtime.env.TRIGGER_TOKEN ?? '';
const authorized = !!token && key === token;

type CitiesJson = {
  cities: Record<string, string[]>;
};

type RunCityRow = {
  city: string | null;
  resolved_city_name: string | null;
};

function normalizeCityName(value: string): string {
  return value
    .trim()
    .normalize('NFKC')
    .toLowerCase()
    .replace(/\s+/g, ' ')
    .replace(/[，,]/g, '')
    .replace(/市$/, '');
}

const cityGroups = Object.entries((citiesData as CitiesJson).cities);
const generatedCitySet = new Set<string>();

if (authorized) {
  const { env } = Astro.locals.runtime;
  const { results } = await env.DB.prepare(
    `SELECT city, resolved_city_name
     FROM generation_runs
     WHERE status = 'succeeded'`
  ).all<RunCityRow>();

  for (const row of results || []) {
    if (row.city) generatedCitySet.add(normalizeCityName(row.city));
    if (row.resolved_city_name) generatedCitySet.add(normalizeCityName(row.resolved_city_name));
  }
}

const groupStats = cityGroups.map(([groupName, cities]) => {
  const items = cities.map((cityName) => ({
    name: cityName,
    generated: generatedCitySet.has(normalizeCityName(cityName)),
  }));
  const generatedCount = items.filter((item) => item.generated).length;
  return {
    groupName,
    items,
    generatedCount,
    total: items.length,
  };
});

const totalCities = groupStats.reduce((sum, group) => sum + group.total, 0);
const totalGenerated = groupStats.reduce((sum, group) => sum + group.generatedCount, 0);
---

{authorized ? (
<Base title="Weather Card — Create">
  <div class="mx-auto max-w-6xl px-5 pt-10 pb-10">
    <div class="rounded-2xl border border-border bg-surface-raised p-5 sm:p-6 shadow-sm">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
        <div>
          <h1 class="font-heading text-xl sm:text-2xl font-600 tracking-tight text-ink">手动生成卡片</h1>
          <p class="mt-1 text-[13px] text-ink-muted">
            已生成 <span id="generated-total" class="font-semibold text-emerald-700">{totalGenerated}</span> / {totalCities} 个城市
          </p>
        </div>
        <div class="flex items-center gap-2 text-[12px] text-ink-muted">
          <span class="inline-flex items-center gap-1.5 rounded-full border border-emerald-200 bg-emerald-100 px-2.5 py-1 text-emerald-800">
            <span class="h-1.5 w-1.5 rounded-full bg-emerald-500"></span> 已生成
          </span>
          <span class="inline-flex items-center gap-1.5 rounded-full border border-stone-200 bg-stone-100 px-2.5 py-1 text-stone-600">
            <span class="h-1.5 w-1.5 rounded-full bg-stone-400"></span> 未生成
          </span>
        </div>
      </div>

      <div id="form-section" class="mt-5">
        <label for="city-input" class="mb-1.5 block text-[13px] text-ink-muted">城市名称（留空随机）</label>
        <div class="flex flex-col gap-2 sm:flex-row">
          <input
            id="city-input"
            type="text"
            placeholder="如：杭州、Tokyo、Paris"
            class="h-10 flex-1 min-w-0 rounded-lg border border-border bg-surface-dim px-3 text-[14px] text-ink placeholder:text-ink-faint outline-none transition-all focus:border-accent focus:ring-2 focus:ring-accent/30"
          />
          <button
            id="btn-submit"
            class="inline-flex h-10 items-center justify-center gap-1.5 rounded-lg bg-ink px-4 text-[14px] font-500 whitespace-nowrap text-surface transition-all hover:bg-ink/85 active:scale-[.98] disabled:opacity-40"
          >
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M22 2 11 13" />
              <path d="m22 2-7 20-4-9-9-4z" />
            </svg>
            生成
          </button>
          <button
            id="btn-random"
            class="inline-flex h-10 items-center justify-center gap-1.5 rounded-lg border border-border px-4 text-[14px] font-500 whitespace-nowrap text-ink transition-all hover:bg-surface-dim active:scale-[.98] disabled:opacity-40"
          >
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="18" height="18" rx="3" />
              <circle cx="8.5" cy="8.5" r="1" fill="currentColor" />
              <circle cx="15.5" cy="15.5" r="1" fill="currentColor" />
              <circle cx="8.5" cy="15.5" r="1" fill="currentColor" />
            </svg>
            随机生成
          </button>
        </div>
      </div>

      <div id="result" class="mt-4 hidden rounded-lg border border-border bg-surface px-3 py-2 text-[13px] text-ink-muted"></div>
    </div>

    <div id="city-catalog" class="mt-6 space-y-4">
      {groupStats.map((group) => (
        <section class="rounded-2xl border border-border bg-surface-raised p-4 sm:p-5 shadow-sm">
          <div class="flex items-center justify-between gap-3">
            <h2 class="font-heading text-[16px] font-600 text-ink">{group.groupName}</h2>
            <p class="text-[12px] text-ink-faint">
              <span class="font-medium text-emerald-700" data-group-generated>{group.generatedCount}</span> / {group.total}
            </p>
          </div>
          <div class="mt-3 flex flex-wrap gap-2">
            {group.items.map((item) => (
              <button
                type="button"
                data-city-chip
                data-city={item.name}
                data-generated={item.generated ? '1' : '0'}
                class={`rounded-lg border px-2.5 py-1.5 text-[13px] font-medium transition-colors ${
                  item.generated
                    ? 'border-emerald-200 bg-emerald-100 text-emerald-800 hover:bg-emerald-200'
                    : 'border-stone-200 bg-stone-100 text-stone-600 hover:bg-stone-200'
                }`}
              >
                {item.name}
              </button>
            ))}
          </div>
        </section>
      ))}
    </div>
  </div>
</Base>
) : (
<Base title="Weather Card">
  <div class="mx-auto max-w-md px-5 pt-16 pb-10 text-center">
    <p class="text-ink-faint text-[14px]">无权访问</p>
  </div>
</Base>
)}

<script define:vars={{ key }}>
  if (!document.getElementById('btn-submit')) throw new Error('unauthorized');

  const cityInput = document.getElementById('city-input');
  const btnSubmit = document.getElementById('btn-submit');
  const btnRandom = document.getElementById('btn-random');
  const resultDiv = document.getElementById('result');
  const cityCatalog = document.getElementById('city-catalog');
  const generatedTotalEl = document.getElementById('generated-total');
  let activeCityChip = null;

  function setActiveCityChip(nextChip) {
    if (activeCityChip && activeCityChip !== nextChip) {
      activeCityChip.classList.remove('ring-2', 'ring-accent/35');
    }
    activeCityChip = nextChip;
    if (activeCityChip) {
      activeCityChip.classList.add('ring-2', 'ring-accent/35');
    }
  }

  function findChipByCity(city) {
    if (!cityCatalog || !city) return null;
    const chips = cityCatalog.querySelectorAll('[data-city-chip]');
    for (const chip of chips) {
      if (chip.getAttribute('data-city') === city) return chip;
    }
    return null;
  }

  function markCityGenerated(chip) {
    if (!chip || chip.dataset.generated === '1') return;
    chip.dataset.generated = '1';
    chip.classList.remove('border-stone-200', 'bg-stone-100', 'text-stone-600', 'hover:bg-stone-200');
    chip.classList.add('border-emerald-200', 'bg-emerald-100', 'text-emerald-800', 'hover:bg-emerald-200');

    const groupCounter = chip.closest('section')?.querySelector('[data-group-generated]');
    if (groupCounter) {
      const current = Number(groupCounter.textContent || '0');
      groupCounter.textContent = String(current + 1);
    }
    if (generatedTotalEl) {
      const current = Number(generatedTotalEl.textContent || '0');
      generatedTotalEl.textContent = String(current + 1);
    }
  }

  async function trigger(city) {
    btnSubmit.disabled = true;
    btnRandom.disabled = true;
    resultDiv.classList.remove('hidden');
    resultDiv.textContent = '正在触发生成…';

    try {
      const params = new URLSearchParams({ key });
      if (city) params.set('city', city);

      const resp = await fetch(`/api/trigger?${params}`, { method: 'POST' });
      const data = await resp.json();

      if (resp.ok) {
        const actualCity = data.city || city || '';
        resultDiv.innerHTML = `<span class="text-green-600">已触发！</span> 城市：${actualCity || '随机'} / Run ID：<code class="text-[12px]">${data.runId}</code>`;

        const chip = findChipByCity(actualCity);
        if (chip) markCityGenerated(chip);
      } else {
        resultDiv.innerHTML = `<span class="text-red-500">失败：</span>${data.error || resp.statusText}`;
      }
    } catch (e) {
      resultDiv.innerHTML = `<span class="text-red-500">请求失败：</span>${e.message}`;
    } finally {
      btnSubmit.disabled = false;
      btnRandom.disabled = false;
    }
  }

  btnSubmit.addEventListener('click', () => trigger(cityInput.value.trim()));
  btnRandom.addEventListener('click', () => {
    cityInput.value = '';
    trigger('');
  });

  cityCatalog?.addEventListener('click', (event) => {
    const target = event.target;
    if (!(target instanceof Element)) return;
    const chip = target.closest('[data-city-chip]');
    if (!chip) return;
    cityInput.value = chip.getAttribute('data-city') || '';
    cityInput.focus();
    setActiveCityChip(chip);
  });

  cityInput.addEventListener('input', () => {
    if (!activeCityChip) return;
    const activeCity = activeCityChip.getAttribute('data-city') || '';
    if (cityInput.value.trim() !== activeCity) {
      activeCityChip.classList.remove('ring-2', 'ring-accent/35');
      activeCityChip = null;
    }
  });

  cityInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') trigger(cityInput.value.trim());
  });
</script>
