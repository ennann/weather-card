---
export const prerender = false;
import Base from "../layouts/Base.astro";
import LogsTable from "../components/LogsTable";
import { getTokenFromCookie } from "../lib/auth";

const accessCode: string = Astro.locals.runtime.env.ACCESS_CODE ?? "";
const cookieToken = getTokenFromCookie(Astro.request);
const authorized = !!accessCode && cookieToken === accessCode;
---

<Base title="Weather Card — Logs">
    <div class="mx-auto max-w-6xl px-5 pt-10 pb-6">
        {
            authorized ? (
                <>
                    <div class="mb-8 fade-in-up">
                        <h1 class="font-heading text-2xl font-600 tracking-tight text-ink">生成日志</h1>
                        <p class="mt-1.5 text-[14px] text-ink-muted">每日卡片生成记录与运行状态</p>
                    </div>
                    <LogsTable client:load />
                </>
            ) : (
                <div class="flex flex-col items-center justify-center py-32 fade-in-up">
                    <h1 class="text-xl font-600 text-ink mb-2">访问受限</h1>
                    <p class="text-sm text-ink-muted mb-6">请输入密码以查看日志</p>
                    <div class="flex flex-col sm:flex-row gap-2 w-full max-w-sm">
                        <input
                            id="token-input"
                            type="password"
                            placeholder="输入访问密码"
                            class="h-10 flex-1 min-w-0 rounded-lg border border-border bg-surface-dim px-3 text-[14px] text-ink placeholder:text-ink-faint outline-none transition-all focus:border-accent focus:ring-2 focus:ring-accent/30"
                        />
                        <button
                            id="btn-token-submit"
                            class="inline-flex h-10 items-center justify-center gap-1.5 rounded-lg bg-ink px-4 text-[14px] font-500 whitespace-nowrap text-surface transition-all hover:bg-ink/85 active:scale-[.98]"
                        >
                            确认
                        </button>
                    </div>
                    <p id="auth-error" class="mt-3 text-sm text-red-500 hidden"></p>
                </div>
            )
        }
    </div>
</Base>

<script>
    const tokenInput = document.getElementById("token-input") as HTMLInputElement;
    const btnTokenSubmit = document.getElementById("btn-token-submit");
    const authError = document.getElementById("auth-error");

    async function submitToken() {
        if (!tokenInput) return;
        const val = tokenInput.value.trim();
        if (!val) return;

        btnTokenSubmit?.setAttribute("disabled", "");
        try {
            const res = await fetch("/api/auth", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ password: val }),
            });
            if (res.ok) {
                window.location.reload();
            } else {
                const data = await res.json().catch(() => ({}));
                if (authError) {
                    authError.textContent = data.error || "认证失败";
                    authError.classList.remove("hidden");
                }
            }
        } catch {
            if (authError) {
                authError.textContent = "网络错误";
                authError.classList.remove("hidden");
            }
        } finally {
            btnTokenSubmit?.removeAttribute("disabled");
        }
    }

    btnTokenSubmit?.addEventListener("click", submitToken);
    tokenInput?.addEventListener("keydown", (e) => {
        if (e.key === "Enter") submitToken();
    });
</script>
